<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Recipe List</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" as="style" crossorigin
	href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
<style>
#recipeList {
	width: 1140px;
	margin: 0 auto;
	display: flex;
	flex-wrap: wrap;
	gap: 22.5px;
	display: flex;
}

.recipe {
	width: 210px;
	cursor: pointer;
}

.recipe .elsa-recipe-all-img {
	width: 100%;
	border: 1px solid #eee;
	border-radius: 5px;
	overflow: hidden;
	box-sizing: border-box;
}

.recipe .elsa-recipe-all-img img {
	display: block;
	width: 100%;
	height: 100%;
	object-fit: cover;
}

.recipe .elsa-recipe-all-info {
	padding: 5px;
	padding-top: 10px;
}

.recipe .elsa-recipe-all-info h3 {
	font-size: 13px;
	color: #666;
	font-weight: 400;
	padding-bottom: 7px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

.recipe .elsa-recipe-all-info p {
	font-size: 14px;
	line-height: 22px;
	overflow: hidden;
	display: -webkit-box;
	-webkit-line-clamp: 2;
	-webkit-box-orient: vertical;
}

.filter-container {
	width:1140px;
	margin:0 auto;
	border: 1px solid #ddd;
	padding: 20px;
	border-radius: 5px;
	margin-bottom: 20px;
}

.container {
	max-width: 1200px;
	margin: 0 auto;
	padding: 0 20px;
}

.filterButtons {
	display: flex;
	justify-content: flex-start;
	margin-bottom: 20px;
}

.filterButtons button {
	margin-right: 10px;
	background: none;
	border: none;
	font-size: 16px;
	cursor: pointer;
	padding: 10px 15px;
	color: black;
	transition: background-color 0.3s, text-decoration 0.3s;
}

.filterButtons button:hover {
	background-color: #e0e0e0;
	text-decoration: underline;
}

.filter-description {
	font-style: italic;
	color: #666;
	margin-bottom: 15px;
}

.filter-section {
	margin-bottom: 15px;
}

.filter-section h4 {
	margin-bottom: 10px;
	color: #333;
}

.checkbox-group {
	display: flex;
	flex-wrap: wrap;
	gap: 10px;
}

.checkbox-group input[type="checkbox"] {
	display:none;
	margin-right: 5px;
}

.checkbox-group label {
	display:inline-block;
	width:100px;
	border:1px solid #eee;
	padding:10px 0;
	text-align:center;
	cursor: pointer;
}

.like-button {
	background: none;
	border: none;
	cursor: pointer;
	position: absolute;
	top: 50%;
	right: 10px;
	transform: translateY(-50%);
}

.like-button i {
	font-size: 24px;
	color: #ccc;
	transition: color 0.3s;
}

.like-button.liked i {
	color: #e74c3c;
}

.search-container {
	display: flex;
	justify-content: center;
	margin-bottom: 20px;
}

.search-container input {
	font-family: "Pretendard Variable", Pretendard;
	width: 300px;
	height: 40px;
	padding-left: 5px;
	box-sizing: border-box;
	font-size: 15px;
	color: #333;
	border: 1px solid #F5A47D;
	border-radius: 5px 0 0 5px;
}

.search-container button {
	font-family: "Pretendard Variable", Pretendard;
	width: 50px;
	background: #F5A47D;
	border: 0;
	color: #fff;
	border-radius: 0 5px 5px 0;
	cursor: pointer;
}
</style>
</head>
<body>
	<header>
		<th:block th:insert="~{/sub/header.html}"></th:block>
	</header>
	<div class="container">
		<div class="filterButtons">
			<button onclick="toggleFilter('filterDiv')">카테고리 검색</button>
		</div>
			<!-- <button onclick="toggleFilter('ingredientDiv')">재료별 검색</button> -->
		<div class="filterButtons">
			<button onclick="toggleFilter('themeDiv')">테마 검색</button>
		</div>
	</div>
	
	<!-- 카테고리 필터 -->
	<div id="filterDiv" class="filter-container">
		<p class="filter-description">
			<i>*원하시는 카테고리를 선택하세요.*</i>
		</p>
		<div id="recipeCategoriesCheckbox" class="filter-section">
			<h4>레시피 카테고리</h4>
			<div class="checkbox-group">
				<!-- 여기에 동적으로 레시피 카테고리 체크박스가 추가됩니다 -->
			</div>
		</div>
	</div>
	
	<!-- 테마 필터 -->
	<div id="themeDiv" class="filter-container">
		<p class="filter-description">
			<i>*원하시는 테마를 선택하세요.*</i>
		</p>
		<div id="recipeThemesCheckbox" class="filter-section">
			<h4>레시피 테마</h4>
			<div class="checkbox-group">
				<!-- 여기에 동적으로 테마 체크박스가 추가됩니다 -->
			</div>
		</div>
	</div>
	
	<!-- 재료 필터 -->
	<!-- <div id="ingredientDiv" class="filter-container">
		<p class="filter-description">
			<i>*이런 재료가 들어간 레시피를 찾아보세요*</i>
		</p>
		<div class="filter-section">
			<h4>재료</h4>
			<div id="ingredientCheckboxes" class="checkbox-group">
				여기에 동적으로 체크박스가 추가됩니다
			</div>
		</div>
	</div> -->
	
	<!-- 검색바 -->
	<div class="search-container">
		<input type="text" id="searchInput"
			placeholder="레시피 이름 + 내용 + 카테고리 + 테마">
		<button>
			<i><img src="/img/search-icon.png"></i>
		</button>
	</div>
	
	<!-- 레시피 리스트 -->
	<section>
		<div id="recipeList">
			<div class="recipe" th:each="recipe : ${recipes}"
				th:onclick="'loadRecipeDetail(\'' + ${recipe.rcode} + '\')'">
				<div class="elsa-recipe-all-img">
					<img
						th:src="${lastImg.get(recipe.rcode).startsWith('DEFAULT:') ? 
              					(lastImg.get(recipe.rcode).substring(8)) : 
              					('/uploads/' + lastImg.get(recipe.rcode))}">
				</div>
				<div class="elsa-recipe-all-info">
					<h3 th:text="${recipe.recipeName}"></h3>
					<p th:text="${recipe.menuName}"></p>
				</div>
			</div>
		</div>
	</section>
	
	<script>
    let selectedCategories = [];
    let excludedIngredients = [];
    let selectedThemes = [];
    let filteredRecipes = [];
    let searchTimeout;

    document.addEventListener('DOMContentLoaded', function() {
        loadRecipeCategories();
        loadIngredients();
        loadRecipeThemes();
        fetchFilteredRecipes();

        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(fetchFilteredRecipes, 300);
        });
    });

    function toggleFilter(divId) {
        const filterDivs = ['filterDiv', 'ingredientDiv', 'themeDiv'];
        filterDivs.forEach(div => {
            const element = document.getElementById(div);
            if (div === divId) {
                element.style.display = element.style.display === 'none' || element.style.display === '' ? 'block' : 'none';
            } else {
                element.style.display = 'none';
            }
        });
    }

    /* 카테고리 필터 */
    function loadRecipeCategories() {
        fetch('/api/menu/recipe-categories')
            .then(response => response.json())
            .then(categories => {
                const categoryGroup = document.querySelector('#recipeCategoriesCheckbox .checkbox-group');
                categories.forEach(category => {
                    const checkbox = document.createElement('div');
                    checkbox.innerHTML = `
                        <input type="checkbox" name="recipeCategory" value="${category}" id="cat${category.replace(/\s+/g, '')}" onchange="applyFilter()">
                        <label for="cat${category.replace(/\s+/g, '')}">${category}</label>
                    `;
                    categoryGroup.appendChild(checkbox);
                });
            })
            .catch(error => console.error('Error:', error));
    }

    /* 재료 필터 */
    function loadIngredients() {
        fetch('/api/menu/ingredients')
            .then(response => response.json())
            .then(ingredients => {
                const checkboxesContainer = document.getElementById('ingredientCheckboxes');
                ingredients.forEach(ingredient => {
                    const checkbox = document.createElement('div');
                    checkbox.innerHTML = `
                        <input type="checkbox" name="ingredient" value="${ingredient.icode}" id="ing${ingredient.icode}" onchange="applyIngredientFilter()">
                        <label for="ing${ingredient.icode}">${ingredient.name}</label>
                    `;
                    checkboxesContainer.appendChild(checkbox);
                });
            })
            .catch(error => console.error('Error:', error));
    }

    /* 테마 필터 */
    function loadRecipeThemes() {
        fetch('/api/menu/recipe-themes')
            .then(response => response.json())
            .then(themes => {
                const themeGroup = document.querySelector('#recipeThemesCheckbox .checkbox-group');
                themes.forEach(theme => {
                    const checkbox = document.createElement('div');
                    checkbox.innerHTML = `
                        <input type="checkbox" name="recipeTheme" value="${theme}" id="theme${theme.replace(/\s+/g, '')}" onchange="applyThemeFilter()">
                        <label for="theme${theme.replace(/\s+/g, '')}">${theme}</label>
                    `;
                    themeGroup.appendChild(checkbox);
                });
            })
            .catch(error => console.error('Error:', error));
    }

    function applyFilter() {
        selectedCategories = Array.from(document.querySelectorAll('input[name="recipeCategory"]:checked')).map(input => input.value);
        fetchFilteredRecipes();
    }

    function applyThemeFilter() {
        selectedThemes = Array.from(document.querySelectorAll('input[name="recipeTheme"]:checked')).map(input => input.value);
        fetchFilteredRecipes();
    }

    function applyIngredientFilter() {
        excludedIngredients = Array.from(document.querySelectorAll('#ingredientCheckboxes input[name="ingredient"]:checked')).map(input => input.value);
        fetchFilteredRecipes();
    }

    function fetchFilteredRecipes() {
        const params = new URLSearchParams();
        
        if (selectedCategories.length > 0) {
            params.append('category', selectedCategories.join(','));
        }
        
        if (excludedIngredients.length > 0) {
            params.append('ingredient', excludedIngredients.join(','));
        }

        if (selectedThemes.length > 0) {
            params.append('theme', selectedThemes.join(','));
        }

        const searchTerm = document.getElementById('searchInput').value;
        if (searchTerm) {
            params.append('searchTerm', searchTerm);
        }

        fetch(`/api/menu/filtered_recipe_list?${params.toString()}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            updateRecipeList(data.recipes, data.lastImgMap);
        })
        .catch(error => console.error('Error:', error));
    }

    function updateRecipeList(filteredRecipes, lastImgMap) {
    	let html = '';
        if (Array.isArray(filteredRecipes) && filteredRecipes.length > 0) {
            filteredRecipes.forEach(recipe => {
                html += `
                	<div class="recipe" th:each="recipe : ${recipes}"
    				th:onclick="'loadRecipeDetail(\'' + ${recipe.rcode} + '\')'">
    				<div class="elsa-recipe-all-img">
    					<img
    						th:src="${lastImg.get(recipe.rcode).startsWith('DEFAULT:') ? 
                  					(lastImg.get(recipe.rcode).substring(8)) : 
                  					('/uploads/' + lastImg.get(recipe.rcode))}">
    				</div>
    				<div class="elsa-recipe-all-info">
    					<h3 th:text="${recipe.recipeName}"></h3>
    					<p th:text="${recipe.menuName}"></p>
    				</div>
    			</div>
                `;
            });
        } else { 
            html = '<p>검색 결과가 없습니다.</p>';
        }
        document.getElementById('recipeList').innerHTML = html;
    }

    function toggleLike(event, button) {
        event.stopPropagation();
        button.classList.toggle('liked');
    }

    function loadRecipeDetail(rcode) {
        window.location.href = `/menu_all/recipe_detail?rcode=${rcode}`;
    }


</script>

</body>
</html>