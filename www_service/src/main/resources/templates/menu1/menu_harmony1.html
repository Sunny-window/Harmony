<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Document</title>
<style>
#mainForm{
	margin-bottom:15px;
}
#mainForm input{
	padding:5px 20px;
	border:1px solid #ccc;
	background:#f9f9f9;
	cursor:pointer;
}

#all-area {
	display: flex;
	justify-content: space-between;
}

.ingredient-area{
	width:240px;
}
.ingredient-area-title{
	text-align:center;
	font-size:14px;
	border:1px solid #ccc;
	padding:5px 0;
	margin-bottom:10px;
}

#haveIngredient {
	height: 500px;
	border: 1px solid #eee;
	padding: 5px;
	display: flex;
	flex-direction: column;
	overflow-y: scroll;
	box-sizing:border-box;
}

.container2 {
	display: flex;
	align-items: center;
	gap: 10px;
	border:1px solid #ccc;
	padding:10px;
	margin-bottom:5px;
}

.container2 div:nth-child(1) {
	font-size: 14px;
}

.container2 div:nth-child(2) {
	font-size: 12px;
	color: #999;
	font-weight: 300;
}

.container2 div:nth-child(3) {
	font-size: 12px;
}


#category {
	font-size:13px;
	padding-right:10px;
	color:#888;
}

.except-ingre {
	display: inline-block;
	padding: 5px;
	padding-top: 2px;
	border: 1px solid #ccc;
	border-radius: 5px;
	background: #f9f9f9;
	font-size: 13px;
	border: 1px solid #ccc;
}

.except-ingre button {
	background: none;
	border: 0;
	cursor: pointer;
	font-size: 20px;
	margin-left: 10px;
	color: red;
}

#NoUseIngredient {
	border: 1px solid #eee;
	padding: 10px;
	display: flex;
	flex-wrap: wrap;
	gap: 10px;
}
#NoUseIngredient button{
	padding:5px 20px;
	border:1px solid #ccc;
	background:#f9f9f9;
	cursor:pointer;
}

.outIngre{
	border:1px solid #ff4444 !important;
	padding:0px 7px !important;
	border-radius:5px !important;
	color:#ff4444 !important;
	transition:all 0.3s !important;
}
.outIngre:hover{
	background:#ff4444 !important;
	color:#fff !important;
}

.possible-recipe{
	width:880px;
}
.possible-recipe-line {
	display: flex;
	justify-content:space-between;
	align-items:center;
	margin-bottom:10px;
	padding:0 10px;
	box-sizing:border-box;
}

.possible-recipe-line-box1{
	display:flex;
	gap:20px;
}

#howToUseBtn{
	border:1px solid #899ED5;
	background:#fff;
	color:#899ED5;
	padding:5px 15px;
	border-radius:5px;
	cursor:pointer;
	transition:all 0.3s;
}
#howToUseBtn:hover{
	background:#899ED5;
	color:#fff;
}

#canMakeMenuDiv {
	height: 500px;
	overflow-y: scroll;
	margin: 0;
	border:1px solid #eee;
	box-sizing:border-box;
	flex-wrap:wrap;
	gap:20px;
	padding:10px;
}
.possible-menu{
	width:180px;
	border:1px solid #eee;
}

.possible-menu-img{
	width:100%;
	height:150px;
	border-bottom:1px solid #eee;
	box-sizing:border-box;
}
.possible-menu-img img{
	width:100%;
	height:100%;
	object-fit:cover;
}
.possible-menu-info{
	text-align:center;
	border-bottom:1px solid #eee;
	padding:10px 0;
}
.possible-menu-go{
	text-align:center;
}



button#xBtn {
	font-size: 13px;
	padding:10px;
	background-color: #fff;
	border: 0;
	cursor: pointer;
	transition:all 0.3s;
}

button#xBtn:hover {
	color: #ff4444;
}

.highlight {
	background-color: rgba(0, 0, 0, 0.1);
	filter: brightness(60%);
	transition: filter 0.3s ease;
	position: relative;
}

.highlight::after {
	content: '제외한 재료입니다';
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	background-color: rgba(255, 0, 0, 0.7);
	color: white;
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 18px;
	z-index: 1;
}

.remove_highlight {
	background-color: rgba(0, 0, 0, 0.1);
	filter: brightness(60%);
	transition: all 0.3s ease;
	position: relative;
}

.remove_highlight::after {
	content: '재료가 부족합니다';
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	background-color: rgba(255, 0, 0, 0.7);
	color: white;
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 18px;
	z-index: 1;
}

input[type="submit"]:hover {
	background-color: #0097a7;
	transform: scale(1.05);
}



#canMakeMenuDiv2 {
	display: none; /* 처음에는 #canMakeMenuDiv2를 숨김 */
}


/* Modal Styles */
.modal {
	display: none;
	position: fixed;
	z-index: 1;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgb(0, 0, 0);
	background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
	background-color: #fefefe;
	margin: 15% auto;
	padding: 20px;
	border: 1px solid #888;
	width: 90%;
	max-width: 500px;
	text-align: center;
	border-radius: 10px;
}

.close {
	color: #aaa;
	float: right;
	font-size: 28px;
	font-weight: bold;
}

.close:hover, .close:focus {
	color: red;
	text-decoration: none;
	cursor: pointer;
}

.asd {
	position: absolute; /* 툴팁을 이 요소에 상대적으로 위치시키기 위해 필요 */
	display: inline-block; /* 툴팁이 정확히 이 요소 위에 표시되도록 하기 위해 */
	cursor: pointer; /* 클릭할 수 있는 요소를 나타내는 커서 변경 */
	left: 67%;
	bottom: 38%;
	color: #EB0000;
}

.tooltip {
	visibility: hidden; /* 기본적으로 숨김 상태 */
	width: 100px; /* 툴팁의 너비 */
	background-color: #555; /* 툴팁 배경색 */
	color: #fff; /* 툴팁 텍스트 색상 */
	text-align: center; /* 텍스트 가운데 정렬 */
	border-radius: 6px; /* 툴팁의 둥근 모서리 */
	padding: 5px; /* 툴팁 내부 여백 */
	position: absolute; /* 절대 위치 */
	z-index: 1; /* 다른 요소 위에 표시되도록 */
	bottom: 30%; /* 요소 위쪽에 위치시키기 위해 */
	left: 30%; /* 수평 중앙 정렬 */
	margin-left: -60px; /* 수평 중앙 정렬을 위한 오프셋 */
	opacity: 0; /* 기본적으로 불투명 상태 */
	transition: opacity 0.3s; /* 페이드 인 효과 */
}

.asd:hover .tooltip {
	visibility: visible; /* 마우스 오버 시 툴팁 표시 */
	opacity: 1; /* 완전히 불투명 상태로 변경 */
}

.high-value {
	color: green;
}

.medium-value {
	color: black;
}

.low-value {
	color: red;
}
</style>
</head>
<body>
	<header>
		<th:block th:insert="~{/sub/header.html}"></th:block>
	</header>
	<section>
		<form id="mainForm" action="/menu1/main" method="get">
			<input type="submit" value="초기화">
		</form>


		<div id="all-area">
			<div class="ingredient-area">
				<div class="ingredient-area-title">나의 냉장고 속 재료들</div>
				<div id="haveIngredient" class="container">
					<div class="row" style="display: none;">냉장고 재료</div>
					<div th:each="dto, iterStat : ${FridgeIngredientListForDto}"
						class="row">
						<input type="hidden" th:value="${dto.icode}"
							th:id="'icode' + ${dto.icode}">
						<div class="container2">
							<div>[[${dto.name}]]</div>
							<div>[[${dto.deadline}]]</div>


							<div th:text="'D' + ${days[iterStat.index]}"
								th:class="${days[iterStat.index] <= 3 ? 'low-value' : (days[iterStat.index] <= 20 ? 'medium-value' : 'high-value')}">
							</div>
							<div>
								<button id="xBtn" type="button" class="outIngre"
									th:onclick="'toggleHighlight(event, \'' + ${dto.icode} + '\');'">-</button>
							</div>
						</div>
					</div>
				</div>
				<div>
					<div style="text-align: center">제외된 재료</div>
					<div id="NoUseIngredient">
						<button onclick="NoUseIngredientAllDelete(event)">전체삭제</button>
					</div>
				</div>
			</div>
			<!-- ingredient-area -->

			<div class="possible-recipe">
				<div class="possible-recipe-line">
					<div class="possible-recipe-line-box1">
						<div>요리가능한 레시피</div>
						<label><input type="checkbox" class="item-checkbox"
							id="toggle-checkbox"> 재료가 부족해요</label>
					</div>
					<div class="howToUse">
						<button id="howToUseBtn">어떻게 쓰나요?</button>
					</div>
				</div>
				<div id="canMakeMenuDiv" class="container">
					<div class="row" style="display: none;">만들 수 있는 메뉴</div>
					<div th:each="dto : ${showCanMakeMenuList}" class="row row9"
						th:id="'canMakeMenuMcode' + ${dto.mcode}">
						<input type="hidden" value="${dto.mcode}">

						<div class="possible-menu">
							<div class="possible-menu-img">
								<img th:src="@{'/uploads/'+ ${dto.imgurl}}">
							</div>
							<div class="possible-menu-info">
							<span id="category">[[${dto.category}]]</span>
								[[${dto.menuName}]]
							</div>
							<div class="possible-menu-go">
								<button id="xBtn" type="button"
									th:onclick="'goRecipeList(event, \'' + ${dto.mcode} + '\')'">레시피
									보러가기 ></button>
							</div>
						</div>
					</div>
				</div>

				<div id="canMakeMenuDiv2" class="container">
					<div class="row" style="display: none;">만들 수 있는 메뉴2</div>
					<div th:each="dto : ${showCanMakeMenuList2}" class="row row9"
						th:id="'canMakeMenuMcode2_' + ${dto.mcode}">
						<input type="hidden" value="${dto.mcode}">
						<p class="asd">
							ⓘ <span class="tooltip">안녕하세요</span>
						</p>
						<div class="container2">
							<div>
								<img th:src="@{'/uploads/'+ ${dto.imgurl}}">
							</div>
							<div class="possible-menu-info">
							<span id="category">[[${dto.category}]]</span>
								[[${dto.menuName}]]
							</div>
							<div class="possible-menu-go">
								<button id="xBtn" type="button"
									th:onclick="'goRecipeList(event, \'' + ${dto.mcode} + '\')'">레시피
									보러가기 ></button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- possible-recipe -->
		</div>
		<!-- all-area -->
	</section>
	<footer>
		<th:block th:insert="~{/sub/footer.html}"></th:block>
	</footer>

	<!-- 모달 구조 추가 -->
	<div id="howToUseModal" class="modal">
		<div class="modal-content">
			<span class="close">x</span>
			<p>*왼쪽의 회원님의 냉장고에 등록된 재료를 기준으로 요리가능한 메뉴를 보여주는 서비스입니다.</p>
			<br>
			<p>1. 좌측 재료목록에서 제외시키고자 하는 재료를 '제외'버튼을 눌러 해당 재료가 포함되지 않은 메뉴들이 우측에
				나타납니다.</p>
			<p>2. 제외시킨 재료에 '복원'버튼을 클릭하면 다시 해당 재료가 포함된 매뉴들이 나타납니다.</p>
			<p>3. 원하는 재료를 선택/제외 하고 난 뒤 우측에 출력되는 메뉴를 클릭할 시 해당 메뉴의 레시피 리스트로
				이동합니다.</p>
			<p>4. 상단의 '재료부족허용'을 체크하게 되면 재료가 1~2가지 부족한 메뉴도 나타납니다.</p>
			<p>5. 4번의 기능이 체크되어있을 시 재료가 1가지 부족한 메뉴의 경우, 메뉴의 상단에 부족한 재료명이
				표기됩니다.</p>
		</div>
	</div>

	<script>
    // 모달 동작을 위한 스크립트
    var modal = document.getElementById("howToUseModal");
    var btn = document.getElementById("howToUseBtn");
    var span = document.getElementsByClassName("close")[0];

    btn.onclick = function() {
        modal.style.display = "block";
    }

    span.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    function toggleHighlight(event, icode) {
        const button = event.currentTarget;
        const row = button.closest('.row');
        const checkboxBtn = document.getElementById('toggle-checkbox');
        let checked = checkboxBtn.checked;
        row.classList.toggle('highlight');

        if (row.classList.contains('highlight')) {
            NoUseIngredient(event);
            deleteIngredient(event, icode);
            if(!checked){
            mcodeListForIcodeList(event, icode);
            } else{
            	
            mcodeListForIcodeList2(event, icode);
            }
            
        } else {
            NoUseIngredient(event);
            undoIngredient2(event, icode);
            if(!checked){
                mcodeListForIcodeList(event, icode);
                } else{
                	
                mcodeListForIcodeList2(event, icode);
                }
                
        }
    }
    function toggleHighlight2(event, icode) {
    	
        const btn = document.getElementById('icode'+icode);
        const checkboxBtn = document.getElementById('toggle-checkbox');
        const row = btn.closest('.row');

        let checked = checkboxBtn.checked;
        console.log("============================toggleHighlight2 row================="+row.id);
        row.classList.toggle('highlight');

      
    }
    
    
    
    function goRecipeList(event, mcode) {
        event.preventDefault();
        window.location.href = '/menu_all/recipe_list?mcode=' + mcode;
    }

    function deleteIngredient(event, icode) {
        event.preventDefault();
        fetch("/menu1/deleteFridgeIngredientList?icode=" + icode, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            // Handle ingredient deletion
            deleteCanMakeMenu(event, icode);
            NoUseIngredient(event);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function mcodeListForIcodeList(event, icode) {
        event.preventDefault();
        console.log("================icode=============: "+icode)
        fetch("/menu1/mcodeListForIcodeList?icode= " + icode, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
        console.log("================data=============: "+data)
            NoUseIngredient(event);
            toggle2(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    
    function mcodeListForIcodeList2(event, icode) {
        event.preventDefault();
        fetch("/menu1/mcodeListForIcodeList2?icode=" + icode, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            NoUseIngredient(event);
            toggle2(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function toggle2(mcodes) {
        let selectedRows = mcodes.map(mcode => document.getElementById("canMakeMenuMcode" + mcode));
        let selectedRows2 = mcodes.map(mcode => document.getElementById("canMakeMenuMcode2_" + mcode));
        let rows = document.querySelectorAll('#canMakeMenuDiv .row:not(:first-child)'); // Exclude header row
        let rows2 = document.querySelectorAll('#canMakeMenuDiv2 .row:not(:first-child)'); // Exclude header row
        let checkBtn = document.getElementById('toggle-checkbox');        
        console.log("================make mcode================ : "+mcodes);
        console.log("================selectedRows================ : "+selectedRows.length);
        console.log("================rows================ : "+rows.length);
        console.log("================rows2================ : "+rows2.length);
        let check = checkBtn.checked;
    
        
            rows.forEach(row => {
                if (!selectedRows.includes(row)) {
                    row.classList.add('remove_highlight');
                } else {
                    row.classList.remove('remove_highlight');
                }
            });
            
            rows2.forEach(row2 => {
                if (!selectedRows2.includes(row2)) {
                    row2.classList.add('remove_highlight');
                } else {
                    row2.classList.remove('remove_highlight');
                }
            });
    }

    function NoUseIngredient(event) {
        event.preventDefault();
        fetch("/menu1/NoUseIngredient", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("NoUseIngredient").innerHTML = CreateNoUseIngredientTable(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function undoIngredient(event, icode) {
        event.preventDefault();
        const checkboxBtn = document.getElementById('toggle-checkbox');

        let checked = checkboxBtn.checked;
        event.preventDefault();
        if(!checked){ 
        	fetch("/menu1/undoIngredient_menu1?icode=" + icode, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            // Handle undoing the ingredient
        	NoUseIngredient(event);
            toggle2(data);
            toggleHighlight2(event, icode)
        })
        .catch(error => {
            console.error('Error:', error);
        });
        
        }else{fetch("/menu1/undoIngredient_menu2?icode=" + icode, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            // Handle undoing the ingredient
        	NoUseIngredient(event);
            toggle2(data);
            toggleHighlight2(event, icode)
        })
        .catch(error => {
            console.error('Error:', error);
        });
        	
        	
        }
        
        
      
    }
    
    
    function NoUseIngredientAllDelete2(event) {
    	event.preventDefault();
        const checkboxBtn = document.getElementById('toggle-checkbox');
        let checked = checkboxBtn.checked
        fetch("/menu1/NoUseIngredientAllDelete", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById("NoUseIngredient").innerHTML =data;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    
    function NoUseIngredientAllDelete(event) {
    	event.preventDefault();
        const checkboxBtn = document.getElementById('toggle-checkbox');
        let checked = checkboxBtn.checked
        
        
    	window.location.href = '/menu1/main?checked='+checked;
    }
    
    
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const checked = urlParams.get('checked') === 'true';  // URL에서 체크박스 상태 가져오기

        const checkboxBtn = document.getElementById('toggle-checkbox');
        if (checkboxBtn) {
            checkboxBtn.checked = checked;  // 체크박스 상태 설정
            document.getElementById('canMakeMenuDiv').style.display = checked ? 'none' : 'flex';
            document.getElementById('canMakeMenuDiv2').style.display = checked ? 'flex' : 'none';
        }
    };
    
    
    
    function undoIngredient2(event, icode) {
    	const checkboxBtn = document.getElementById('toggle-checkbox');
    
        fetch("/menu1/undoIngredient2?icode=" + icode, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            // Handle undoing the ingredient
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    function CreateNoUseIngredientTable(jsonData) {
        var html = '';

        if (jsonData.length === 0) {
            html += '';
        } else {
            // 배열이 있고 데이터가 있는 경우
            jsonData.forEach(item => {
                html += '<div>';
                html += '<form id="mainForm" action="/menu1/main" method="get">'
                html += '<input type="submit" value="초기화">';
				html += '</form>';
                html += '<div class="except-ingre">' + item.name;
                html += '<button type="button" onclick="undoIngredient(event, \'' + item.icode + '\')">x</button>';
                html += '</div>';
            	html += '</div>';
            });

        }

        return html;
    }

    function CreateNoUseIngredientTable_backUp(jsonData) {
        var html = '';

        if (jsonData.length === 0) {
            html += '';
        } else {
            // 배열이 있고 데이터가 있는 경우
            html += '<table border="1" style="margin: 0 auto; text-align: center;">';
            html += '<tr>';
            html += '<th>메뉴추천에서 제외한 메뉴</th>';
            html += '<th>복원</th>';
            html += '</tr>';

            jsonData.forEach(item => {
                html += '<tr>';
                html += '<td>' + item.name + '</td>';
                html += '<td><button type="button" onclick="undoIngredient(event, \'' + item.icode + '\')">x</button></td>';
                html += '</tr>';
            });

            html += '</table>';
        }

        return html;
    }
    
 
    function CreateNoUseIngredientTable_backUp(jsonData) {
        var html = '';

        if (jsonData.length === 0) {
            html += '';
        } else {
            // 배열이 있고 데이터가 있는 경우
            html += '<table border="1" style="margin: 0 auto; text-align: center;">';
            html += '<tr>';
            html += '<th>메뉴추천에서 제외한 메뉴</th>';
            html += '<th>복원</th>';
            html += '</tr>';

            jsonData.forEach(item => {
                html += '<tr>';
                html += '<td>' + item.name + '</td>';
                html += '<td><button type="button" onclick="undoIngredient(event, \'' + item.icode + '\')">x</button></td>';
                html += '</tr>';
            });

            html += '</table>';
        }

        return html;
    }
    document.getElementById('toggle-checkbox').addEventListener('change', function() {
        var isChecked = this.checked;
        document.getElementById('canMakeMenuDiv').style.display = isChecked ? 'none' : 'flex';
        document.getElementById('canMakeMenuDiv2').style.display = isChecked ? 'flex' : 'none';
    });
    </script>
</body>
</html>
